name: Windows RDP with High Performance

name: Windows RDP with Ngrok Tunnel

on:
  workflow_dispatch:
    inputs:
      rdp_duration:
        description: 'RDP session duration in minutes (max 360)'
        required: false
        default: '180'
        type: string

jobs:
  setup-windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Ngrok Tunnel
      run: |
        Write-Host "Setting up Ngrok tunnel..." -ForegroundColor Yellow

        # Ngrok Auth (Replace this with your authtoken)
        $NGROK_AUTH_TOKEN = "YOUR_NGROK_AUTH_TOKEN_HERE"

        Invoke-WebRequest -Uri https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive -Path ngrok.zip -DestinationPath . -Force

        .\ngrok.exe authtoken $NGROK_AUTH_TOKEN

        Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389" -NoNewWindow -RedirectStandardOutput "ngrok_output.txt"

        Start-Sleep -Seconds 10

        $output = Get-Content "ngrok_output.txt" -Raw
        if ($output -match "tcp://(.+):(\d+)") {
          $host = $matches[1]
          $port = $matches[2]
          $url = "$host:$port"
          echo "NGROK_URL=$url" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "Ngrok tunnel is running at $url" -ForegroundColor Green
        } else {
          Write-Host "Could not detect Ngrok tunnel address." -ForegroundColor Red
        }

    - name: Display Connection Information
      run: |
        Write-Host "=== FINAL SYSTEM STATUS ===" -ForegroundColor Green
        Write-Host ""
        Write-Host "RDP is now enabled and configured for high performance" -ForegroundColor Green
        Write-Host "Session will remain active for ${{ github.event.inputs.rdp_duration }} minutes" -ForegroundColor Green
        Write-Host "=== CONNECTION DETAILS ===" -ForegroundColor Green
        Write-Host "Username: rdpuser" -ForegroundColor Cyan
        Write-Host "Password: P@ssw0rd123!" -ForegroundColor Cyan
        Write-Host "Port: 3389" -ForegroundColor Cyan
        Write-Host "Ngrok Public URL: $env:NGROK_URL" -ForegroundColor Cyan
        Write-Host "==================================" -ForegroundColor Green

    - name: Keep session alive
      run: |
        Write-Host "Keeping RDP session alive for ${{ github.event.inputs.rdp_duration }} minutes..." -ForegroundColor Yellow
        $duration = [int]"${{ github.event.inputs.rdp_duration }}"
        $endTime = (Get-Date).AddMinutes($duration)

        powercfg -change -standby-timeout-ac 0
        powercfg -change -hibernate-timeout-ac 0
        powercfg -change -monitor-timeout-ac 0

        while ((Get-Date) -lt $endTime) {
          $remaining = $endTime - (Get-Date)
          $hours = [math]::Floor($remaining.TotalHours)
          $minutes = $remaining.Minutes
          $seconds = $remaining.Seconds

          Write-Host "Session active. Time remaining: ${hours}h ${minutes}m ${seconds}s" -ForegroundColor Green
          Write-Host "Ngrok Public URL: $env:NGROK_URL" -ForegroundColor Cyan

          Get-Date | Out-Null
          Start-Sleep -Seconds 60
        }

        Write-Host "RDP session time expired. Workflow will end." -ForegroundColor Red
        
